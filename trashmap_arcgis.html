<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9" />
    <title>
      Philly Sanitation Map
    </title>
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.5/js/esri/css/esri.css">
    
    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.5compact">
    </script>
    <style type="text/css">
      html, body
      {
        height: 100%;
        margin: 0px;
        padding: 0px;
        width: 100%;
      }
      .esriSimpleSlider
       div
      {
        height: 30px !important;
        width: 30px !important;
      }
    </style>
    <script type="text/javascript">
      dojo.require("esri.map");
      dojo.require("esri.tasks.query");
      dojo.require("esri.tasks.QueryTask");
      dojo.require("esri.dijit.PopupMobile");
      var map;
      var qryTrash, qryRecycling, qryTrashTask, qryRecyclingTask;
      var myOnClick_connect;
      var popup;

      function init() {
        qryTrashTask = new esri.tasks.QueryTask('http://gis.phila.gov/ArcGIS/rest/services/PhilaGov/ServiceAreas/MapServer/13');
        qryRecyclingTask = new esri.tasks.QueryTask('http://gis.phila.gov/ArcGIS/rest/services/PhilaGov/ServiceAreas/MapServer/12');
        
        qryTrash = new esri.tasks.Query();
        qryTrash.returnGeometry = false;
        qryTrash.outFields = ["COLLDAY"];
        qryRecycling = new esri.tasks.Query();
        qryRecycling.returnGeometry = false;
        qryRecycling.outFields = ["COLLDAY"];

        var initialExtent = new esri.geometry.Extent({
          "xmin": 2557616.45757814,
          "ymin": 207781.230364257,
          "xmax": 2834147.13141866,
          "ymax": 306565.784101792,
          "spatialReference": {
           "wkid": 2272
          }
        });
        
        popup = new esri.dijit.PopupMobile(null, dojo.create("div"));
        
        map = new esri.Map("map", {
          extent: initialExtent,
        });
        
        map.setInfoWindow(popup);

        var tiledMapServiceLayer = new esri.layers.ArcGISTiledMapServiceLayer("http://gis.phila.gov/ArcGIS/rest/services/BaseMaps/GrayBase/MapServer");
        map.addLayer(tiledMapServiceLayer);

        myOnClick_connect = dojo.connect(map, "onClick", gotClick);
      }
      
      function gotClick(event) {
        searchPickup(event.mapPoint);	
      }
      
      function searchPickup(coords) {
        // pass in esri.geometry.Point
        
        map.infoWindow.hide();
        
        qryTrash.geometry = coords;
        qryRecycling.geometry = coords;
        qryTrashTask.execute(qryTrash, function(trash) {
          if (trash.features.length > 0) {
            var trashDay = trash.features[0].attributes['COLLDAY'];
            console.log('trash: ' + trashDay);
            qryRecyclingTask.execute(qryRecycling, function(recycling) {
              if (recycling.features.length > 0) {
                var recycleDay = recycling.features[0].attributes['COLLDAY'];
                console.log('recycle: ' + recycleDay);
                //map.infoWindow.setTitle('trash: ' + trashDay + ' ' + 
                //  'recycling: ' + recycleDay);
                map.infoWindow.setTitle("trash: " + trashDay + " " + 
                  "recycling: " + recycleDay);
                
                map.infoWindow.show(coords);
              } else {
                console.log("no recycling day found");
              }
            });
          } else {
            console.log("no trash day found for selected location");
          }
        });
      }
      
      function orientationChanged() {
        console.log("Orientation changed: " + window.orientation);
        if(map){
          map.reposition();
          map.resize();
        }
      }
      
      function cleanup() {
        dojo.disconnect(myOnClick_connect);
      }

      dojo.addOnLoad(init);
      dojo.addOnUnload(cleanup);
    </script>
  </head>

  <body onorientationchange="orientationChanged();">
    <div id="map" style="width:100%; height:100%;">
    </div>
  </body>

</html>

