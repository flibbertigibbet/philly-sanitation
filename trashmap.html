<!DOCTYPE html>
<html style="height:100%">
<head>
<title>Philly Sanitation Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1,
    minimum-scale=1, maximum-scale=1, user-scalable=no, target-densityDpi=device-dpi" />
<script src="http://maps.google.com/maps/api/js?v=3.exp&sensor=true"></script>
 <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
</head>
<body style="height:100%">
<script type='text/javascript'>
google.maps.visualRefresh = true;
var mapDiv;
var map;
var marker;
var infowindow;
var today;
var weekday;

var qryRecycle = 'http://gis.phila.gov/ArcGIS/rest/services/PhilaGov/ServiceAreas/MapServer/12/' + 
    'query?f=json&inSR=4326&geometry={"spatialReference":{"wkid":4326},"x":'
var qryTrash = 'http://gis.phila.gov/ArcGIS/rest/services/PhilaGov/ServiceAreas/MapServer/13/' + 
    'query?f=json&inSR=4326&geometry={"spatialReference":{"wkid":4326},"x":'
var qryMid = ',"y":'
var qryEnd = '}&geometryType=esriGeometryPoint&spatialRel=esriSpatialRelIntersects&outSR=' + 
    '4326&returnCountOnly=False&returnIdsOnly=False&returnGeometry=False&outFields=COLLDAY'
    
var geocoder = 'http://services.phila.gov/ULRS311/Data/Location/'
var reverseGeocoder = 'http://services.phila.gov/ULRS311/Data/Address/'

function checkHoliday() {
    today = new Date();
    console.log( today + ' is on weekday ' + weekday[today.getDay()] );
    // TODO: check if today is a holiday on the collection schedule
}

function getCollectionDays(x, y, standardAddr) {
    var trashDay = '';
    var recycleDay = '';
    $.getJSON(qryTrash + x + qryMid + y + qryEnd, function(result) {
        if (result.features.length > 0) {
            trashDay = result.features[0].attributes.COLLDAY;
            $.getJSON(qryRecycle + x + qryMid + y + qryEnd, function(result) {
                recycleDay = result.features[0].attributes.COLLDAY;
                
                var pos = new google.maps.LatLng(y, x);
    
                console.log(trashDay);
                console.log(recycleDay);
                // TODO: check if next scheduled collection date is a holiday
                
                markSpot(pos, '<div style="width:150px"><p>' + standardAddr + 
                    '</p><h4>trash: ' + trashDay +
                    '</h4><h4>recycling: ' + recycleDay + '</h4></div>');
             });
        } else {
            // no trash day found
            console.log('no trash day found for x:' + x + ' y:' + y);
            marker.setPosition(null);
            infowindow.close(marker.get('map'), marker);
        }
    });
}

function searchAddress() {
    var address = document.getElementById('address').value;
  
    $.getJSON(geocoder + encodeURI(address), function(result) {
        if (result.Locations.length > 0) {
            var standardAddr = result.Locations[0].Address.StandardizedAddress;
            var similarity = result.Locations[0].Address.Similarity;
            var x = result.Locations[0].XCoord
            var y = result.Locations[0].YCoord
            
            getCollectionDays(x, y, standardAddr);
        } else {
            // no match found
            marker.setPosition(null);
            infowindow.close(marker.get('map'), marker);
        }
    });
}

function detectBrowser() {
  var useragent = navigator.userAgent;

  if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1 ) {
    mapDiv.style.width = '100%';
    mapDiv.style.height = '100%';
  } else {
    mapDiv.style.width = '600px';
    mapDiv.style.height = '600px';
  }
}

function initialize() {
  weekday = new Array(7);
  weekday[0] = 'SUN';
  weekday[1] = 'MON';
  weekday[2] = 'TUE';
  weekday[3] = 'WED';
  weekday[4] = 'THU';
  weekday[5] = 'FRI';
  weekday[6] = 'SAT';
  
  mapDiv = document.getElementById('map');
  //detectBrowser();
  var mapOptions = {
    zoom: 12,
    center: new google.maps.LatLng(39.95278,-75.163851),
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };
  map = new google.maps.Map(mapDiv, mapOptions);
  
  var image = 'images/trash.png';
  marker = new google.maps.Marker({map:map, title:'sanitation collection', icon:image});
  infowindow = new google.maps.InfoWindow({
    content:'Howdy!'
  });
  
 google.maps.event.addListener(marker, 'click', function() {
    infowindow.open(marker.get('map'), marker);
 });
    
google.maps.event.addDomListener(map, 'click', function(e) {
   console.log('clicked on ' + e.latLng.toString());
    
    // reverse geocode for address to put in label
    $.getJSON(reverseGeocoder + e.latLng.lng() + '/' + e.latLng.lat(), function(result) {
        if (result.Locations.length > 0) {
            var standardAddr = result.Locations[0].Address.StandardizedAddress;
            var similarity = result.Locations[0].Address.Similarity;
            
            getCollectionDays(e.latLng.lng(), e.latLng.lat(), standardAddr);
        } else {
            // no address found; try getting trash days anyways
            getCollectionDays(e.latLng.lng(), e.latLng.lat(), e.latLng.toString());
        }
    });
});
  
  // check if today is a holiday
  checkHoliday();
  
  // try HTML5 geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(success, error);
  } else {
    error("no HTML5 geolocation available");
  }
}

function success(position) {
    //getCollectionDays(position.coords.longitude, position.coords.latitude, 
    //    position.coords.latitude.toString() + ', ' + position.coords.longitude.toString());
    
    // reverse geocode for address to put in label
    $.getJSON(reverseGeocoder + position.coords.longitude + '/' + 
        position.coords.latitude, function(result) {
        if (result.Locations.length > 0) {
            var standardAddr = result.Locations[0].Address.StandardizedAddress;
            var similarity = result.Locations[0].Address.Similarity;
            
            getCollectionDays(position.coords.longitude, position.coords.latitude, standardAddr);
        } else {
            // no address found; try getting trash days anyways
            getCollectionDays(position.coords.longitude, position.coords.latitude,
                position.coords.latitude.toString() + ', ' + position.coords.longitude.toString());
        }
    });
}

function error(msg) {
  console.log(msg);
}

function markSpot(position, msg) {
    marker.setPosition(position);
    map.panTo(position);
    infowindow.setContent(msg);
    infowindow.open(marker.get('map'), marker);
}

google.maps.event.addDomListener(window, 'load', initialize);
</script>
<div id="map" style="width:100%;height:100%"></div>
<div id="panel" style="position:absolute;top:20px;left:50%;margin-left:-40%;z-index:5;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    padding:5px;border:2px solid;border-radius:25px;border-color:blue;box-shadow:10px 10px 5px #888888;
    background-color:blue">
    <input id="address" type="text" placeholder="enter address">
    <input type="button" value="Search" onclick="searchAddress()">
</div>
</body>
</html>
